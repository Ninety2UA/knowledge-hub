---
phase: 01-project-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - tests/__init__.py
  - tests/conftest.py
  - tests/test_health.py
  - tests/test_models/__init__.py
  - tests/test_models/test_slack.py
  - tests/test_models/test_content.py
  - tests/test_models/test_knowledge.py
  - tests/test_models/test_notion.py
  - Dockerfile
  - .dockerignore
autonomous: true
requirements: []

must_haves:
  truths:
    - "pytest runs and all tests pass"
    - "At least one test per model validates schema correctness"
    - "Health endpoint test confirms 200 OK with expected JSON"
    - "Docker image builds successfully"
    - "Docker container responds to GET /health with 200 OK"
  artifacts:
    - path: "tests/conftest.py"
      provides: "Shared test fixtures (TestClient)"
      contains: "TestClient"
    - path: "tests/test_health.py"
      provides: "Health endpoint test"
      contains: "def test_health"
    - path: "tests/test_models/test_slack.py"
      provides: "SlackEvent model validation tests"
      contains: "def test_"
    - path: "tests/test_models/test_content.py"
      provides: "ExtractedContent model validation tests"
      contains: "def test_"
    - path: "tests/test_models/test_knowledge.py"
      provides: "KnowledgeEntry model validation tests"
      contains: "def test_"
    - path: "tests/test_models/test_notion.py"
      provides: "NotionPage model validation tests"
      contains: "def test_"
    - path: "Dockerfile"
      provides: "Production container image build"
      contains: "uvicorn knowledge_hub.app:app"
    - path: ".dockerignore"
      provides: "Docker build exclusions"
      contains: ".venv"
  key_links:
    - from: "tests/conftest.py"
      to: "src/knowledge_hub/app.py"
      via: "TestClient(app)"
      pattern: "from knowledge_hub\\.app import app"
    - from: "tests/test_models/*.py"
      to: "src/knowledge_hub/models/*.py"
      via: "import models and instantiate"
      pattern: "from knowledge_hub\\.models import"
    - from: "Dockerfile"
      to: "pyproject.toml"
      via: "uv sync installs dependencies"
      pattern: "uv sync"
---

<objective>
Write comprehensive tests for all models and the health endpoint, then create the Docker image that builds and runs the app with the same health check behavior.

Purpose: Validate that the scaffold from Plan 01 works correctly (tests) and is deployable (Docker). This completes all 5 Phase 1 success criteria.
Output: Passing test suite, buildable Docker image, verified container health endpoint.
</objective>

<execution_context>
@/Users/dbenger/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dbenger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-CONTEXT.md
@.planning/phases/01-project-foundation/01-RESEARCH.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write all tests and verify they pass</name>
  <files>
    tests/__init__.py
    tests/conftest.py
    tests/test_health.py
    tests/test_models/__init__.py
    tests/test_models/test_slack.py
    tests/test_models/test_content.py
    tests/test_models/test_knowledge.py
    tests/test_models/test_notion.py
  </files>
  <action>
    **Create test infrastructure and model tests. Use plain `def` test functions (NOT async) with FastAPI TestClient for endpoint tests and direct Pydantic instantiation for model tests.**

    **File 1: tests/__init__.py**
    Empty file. Required for pytest discovery in src layout.

    **File 2: tests/conftest.py**
    - Import `TestClient` from `fastapi.testclient`
    - Import `app` from `knowledge_hub.app`
    - Create a `client` fixture (session-scoped) returning `TestClient(app)`

    **File 3: tests/test_health.py**
    - `test_health_returns_200(client)`: GET /health returns 200
    - `test_health_response_body(client)`: Response JSON contains `{"status": "ok", "service": "knowledge-hub", "version": "0.1.0"}`

    **File 4: tests/test_models/__init__.py**
    Empty file.

    **File 5: tests/test_models/test_slack.py**
    - `test_slack_event_valid()`: Create SlackEvent with all required fields, assert all fields match
    - `test_slack_event_with_user_note()`: Create with optional user_note, assert it is set
    - `test_slack_event_without_user_note()`: Create without user_note, assert it defaults to None
    - `test_slack_event_multiple_urls()`: Create with multiple URLs in extracted_urls list, assert length
    - `test_slack_event_missing_required_field()`: Omit channel_id, assert `ValidationError` is raised

    **File 6: tests/test_models/test_content.py**
    - `test_extracted_content_minimal()`: Create with only url and content_type (required fields), assert all optional fields are None
    - `test_extracted_content_full()`: Create with all fields populated, assert values
    - `test_content_type_enum_values()`: Assert ContentType has exactly 7 members with correct string values
    - `test_extracted_content_is_partial_default()`: Assert is_partial defaults to False
    - `test_extracted_content_article_no_transcript()`: Create article type with text but no transcript, assert transcript is None

    **File 7: tests/test_models/test_knowledge.py**
    - `test_knowledge_entry_valid()`: Create with all required fields, assert values match
    - `test_knowledge_entry_default_status()`: Create entry, assert status defaults to Status.NEW
    - `test_knowledge_entry_empty_tags()`: Create without tags, assert defaults to empty list
    - `test_category_enum_count()`: Assert Category enum has exactly 11 members
    - `test_priority_enum_values()`: Assert Priority enum has HIGH, MEDIUM, LOW
    - `test_status_enum_values()`: Assert Status enum has NEW, REVIEWED, APPLIED, ARCHIVED
    - `test_knowledge_entry_invalid_category()`: Pass invalid category string, assert ValidationError

    **File 8: tests/test_models/test_notion.py**
    - `test_notion_page_valid()`: Create NotionPage with valid KnowledgeEntry and all 4 sections, assert fields
    - `test_key_learning_structure()`: Create KeyLearning with what, why_it_matters, how_to_apply list, assert all fields
    - `test_notion_page_key_learnings_list()`: Create with multiple KeyLearning entries, assert list length
    - `test_notion_page_requires_entry()`: Omit entry field, assert ValidationError

    **After writing all files, run:** `uv run pytest -v` and confirm all tests pass.
  </action>
  <verify>
    1. `uv run pytest -v` exits with code 0 and shows all tests passing
    2. `uv run pytest --co -q` lists at least 20 test items (minimum 5 per model + 2 health)
    3. No warnings about async mode or unhandled coroutines in pytest output
  </verify>
  <done>
    All tests pass. At least one test per model validates schema correctness. Health endpoint test confirms 200 OK with expected JSON body. Test count >= 20 across all files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile and .dockerignore, build and verify Docker image</name>
  <files>
    Dockerfile
    .dockerignore
  </files>
  <action>
    **Create the Docker build configuration and verify the image works.**

    **File 1: .dockerignore**
    ```
    .venv/
    .git/
    .env
    .env.*
    __pycache__/
    *.pyc
    tests/
    docs/
    .planning/
    .claude/
    .DS_Store
    *.egg-info/
    dist/
    build/
    ```

    **File 2: Dockerfile**
    Use the optimized uv Docker pattern from research:
    - Base image: `python:3.12-slim`
    - Copy uv binary: `COPY --from=ghcr.io/astral-sh/uv:0.10.4 /uv /uvx /bin/`
    - Environment: `UV_COMPILE_BYTECODE=1`, `UV_LINK_MODE=copy`, `UV_NO_DEV=1`
    - WORKDIR: `/app`
    - Dependency layer (cached): `RUN --mount=type=cache,target=/root/.cache/uv --mount=type=bind,source=uv.lock,target=uv.lock --mount=type=bind,source=pyproject.toml,target=pyproject.toml uv sync --locked --no-install-project`
    - Source layer: `COPY . /app`
    - Project install: `RUN --mount=type=cache,target=/root/.cache/uv uv sync --locked`
    - PATH: `ENV PATH="/app/.venv/bin:$PATH"`
    - EXPOSE 8080
    - CMD: `["uvicorn", "knowledge_hub.app:app", "--host", "0.0.0.0", "--port", "8080"]`

    **Build and verify:**
    1. Run `docker build -t knowledge-hub:dev .` from project root
    2. Run `docker run -d --name kb-test -p 8081:8080 knowledge-hub:dev`
    3. Wait 3 seconds for startup, then `curl http://localhost:8081/health`
    4. Verify response is `{"status": "ok", "service": "knowledge-hub", "version": "0.1.0"}`
    5. Stop and remove: `docker stop kb-test && docker rm kb-test`
    6. Clean up image if desired (optional -- executor's choice)
  </action>
  <verify>
    1. `docker build -t knowledge-hub:dev .` exits with code 0
    2. Container starts and `curl http://localhost:8081/health` returns 200 with expected JSON
    3. Docker image size is reasonable (< 300MB for python:3.12-slim + deps)
  </verify>
  <done>
    Dockerfile builds successfully. Container responds to GET /health with 200 OK and correct JSON body. .dockerignore prevents .venv, .git, tests, and secrets from leaking into the image.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest -v` -- all tests pass, 0 failures
2. `docker build -t knowledge-hub:dev .` -- exits 0
3. Docker container health check returns 200 OK with `{"status": "ok", "service": "knowledge-hub", "version": "0.1.0"}`
4. All 5 Phase 1 success criteria are met:
   - [x] FastAPI app starts and responds to GET /health with 200 OK
   - [x] All Pydantic data models are defined and importable
   - [x] Config loading reads environment variables with sensible defaults
   - [x] Docker image builds and runs with same health check behavior
   - [x] pytest runs and passes with at least one test per model
</verification>

<success_criteria>
- `uv run pytest -v` passes with 0 failures and >= 20 tests
- Docker image builds in under 2 minutes
- Docker container health endpoint returns expected JSON
- All Phase 1 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-02-SUMMARY.md`
</output>
