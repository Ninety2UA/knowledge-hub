---
phase: 02-slack-ingress
plan: 02
type: tdd
wave: 2
depends_on:
  - 02-01
files_modified:
  - tests/test_slack/__init__.py
  - tests/test_slack/test_urls.py
  - tests/test_slack/test_handlers.py
  - tests/test_slack/test_router.py
  - tests/conftest.py
autonomous: true
requirements:
  - INGEST-01
  - INGEST-02
  - INGEST-03
  - INGEST-04
  - INGEST-05
  - INGEST-06
  - INGEST-07
  - INGEST-08

must_haves:
  truths:
    - "URL extraction correctly parses Slack mrkdwn angle-bracket format"
    - "User note extraction strips URL markup and returns cleaned text or None"
    - "Bot messages, edits, thread replies, wrong users, and URL-less messages are filtered"
    - "URL verification challenge returns the challenge token"
    - "Slack retry header causes immediate 200 without processing"
    - "Multiple URLs are capped at 10 and dispatched to background"
    - "Invalid signatures return 403"
  artifacts:
    - path: "tests/test_slack/test_urls.py"
      provides: "URL extraction and user note unit tests"
      min_lines: 60
    - path: "tests/test_slack/test_handlers.py"
      provides: "Message filter and dispatch logic tests"
      min_lines: 80
    - path: "tests/test_slack/test_router.py"
      provides: "Endpoint integration tests with signature verification"
      min_lines: 60
  key_links:
    - from: "tests/test_slack/test_urls.py"
      to: "src/knowledge_hub/slack/urls.py"
      via: "imports extract_urls, extract_user_note"
      pattern: "from knowledge_hub.slack.urls import"
    - from: "tests/test_slack/test_router.py"
      to: "src/knowledge_hub/app.py"
      via: "TestClient(app) for integration tests"
      pattern: "TestClient.*app"
---

<objective>
TDD tests for the Slack ingress layer: unit tests for URL extraction pure functions, unit tests for message filtering logic, and integration tests for the /slack/events endpoint.

Purpose: Verify all 8 INGEST requirements are met with comprehensive test coverage of URL parsing, message filtering, signature verification, retry dedup, and background dispatch.

Output: 3 test files covering URL extraction, handler logic, and router integration
</objective>

<execution_context>
@/Users/dbenger/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dbenger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-slack-ingress/02-CONTEXT.md
@.planning/phases/02-slack-ingress/02-RESEARCH.md
@.planning/phases/02-slack-ingress/02-01-SUMMARY.md
@src/knowledge_hub/slack/urls.py
@src/knowledge_hub/slack/handlers.py
@src/knowledge_hub/slack/router.py
@src/knowledge_hub/slack/verification.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD unit tests for URL extraction and user note</name>
  <files>tests/test_slack/__init__.py, tests/test_slack/test_urls.py</files>
  <action>
1. Create `tests/test_slack/__init__.py` (empty, package marker).

2. Create `tests/test_slack/test_urls.py` with RED-GREEN tests for `extract_urls` and `extract_user_note`:

**extract_urls tests (INGEST-02):**
- `test_extract_url_with_label` -- `"Check <https://example.com|Cool Article>"` -> `["https://example.com"]`
- `test_extract_url_without_label` -- `"Link: <https://example.com/page>"` -> `["https://example.com/page"]`
- `test_extract_multiple_urls` -- message with 2 URLs -> list of 2 URLs
- `test_extract_no_urls` -- `"just text no links"` -> `[]`
- `test_extract_ignores_user_mention` -- `"Hey <@U12345> check <https://example.com>"` -> `["https://example.com"]` only
- `test_extract_ignores_channel_ref` -- `"See <#C12345> and <https://example.com>"` -> `["https://example.com"]` only
- `test_extract_ignores_special_commands` -- `"<!here> <https://example.com>"` -> `["https://example.com"]` only
- `test_extract_url_with_query_params` -- `"<https://youtube.com/watch?v=abc&t=120>"` -> preserves query string
- `test_extract_url_with_pipe_in_query` -- edge case: URL containing pipe char (if any) -- verify regex handles it correctly
- `test_extract_http_url` -- `"<http://example.com>"` -> `["http://example.com"]` (not just https)

**extract_user_note tests (INGEST-03):**
- `test_user_note_with_text_and_url` -- `"Great read on AI <https://example.com>"` -> `"Great read on AI"`
- `test_user_note_url_only` -- `"<https://example.com>"` -> `None`
- `test_user_note_multiple_urls_with_text` -- `"Check these <https://a.com> and <https://b.com> for reference"` -> `"Check these  and  for reference"` (stripped URL markup, may have extra spaces -- verify actual behavior)
- `test_user_note_empty_string` -- `""` -> `None`
- `test_user_note_whitespace_only_after_removal` -- `"  <https://example.com>  "` -> `None` (whitespace stripped)

All tests are plain `def test_*()` functions (sync, pure functions). Follow project convention: `test_{function}_{scenario}` naming.
  </action>
  <verify>
- `uv run pytest tests/test_slack/test_urls.py -v` -- all tests pass
- `uv run ruff check tests/test_slack/test_urls.py` -- linter clean
  </verify>
  <done>All URL extraction and user note tests pass. Both `<url>` and `<url|label>` formats correctly handled. User mentions, channel refs, and special commands excluded. User note correctly strips URL markup.</done>
</task>

<task type="auto">
  <name>Task 2: Handler filter tests and router integration tests</name>
  <files>tests/test_slack/test_handlers.py, tests/test_slack/test_router.py, tests/conftest.py</files>
  <action>
1. Create `tests/test_slack/test_handlers.py` -- unit tests for `handle_message_event` filtering logic:

**Filter tests (INGEST-05, INGEST-06):**
- `test_ignores_non_message_type` -- event with `type: "app_mention"` -> no dispatch
- `test_ignores_subtype_bot_message` -- event with `subtype: "bot_message"` -> no dispatch (INGEST-05)
- `test_ignores_subtype_message_changed` -- event with `subtype: "message_changed"` -> no dispatch
- `test_ignores_bot_id` -- event with `bot_id: "B123"` but no subtype -> no dispatch (belt-and-suspenders)
- `test_ignores_wrong_user` -- event with `user: "U_OTHER"` when allowed_user_id is `"U_ALLOWED"` -> no dispatch
- `test_ignores_thread_reply` -- event with `thread_ts: "123.456"` -> no dispatch
- `test_ignores_no_urls` -- regular message with no URLs -> no dispatch (INGEST-06)
- `test_processes_valid_message` -- message from allowed user with URL -> dispatch called

**Multi-URL tests (INGEST-07):**
- `test_multiple_urls_dispatched` -- message with 3 URLs -> background task receives all 3
- `test_urls_capped_at_10` -- message with 12 URLs -> only first 10 passed to background task

To test these, mock `BackgroundTasks` and `get_settings()`. Use `unittest.mock.patch` to mock `get_settings` to return a Settings with `allowed_user_id="U_ALLOWED"`. Check that `background_tasks.add_task` was called (or not) with expected args.

These tests can be async (since `handle_message_event` is async). Use `pytest.mark.asyncio` or rely on project's `asyncio_mode = "auto"` setting.

2. Create `tests/test_slack/test_router.py` -- integration tests using TestClient:

Add a helper to `tests/conftest.py` or in the test file: a function `make_slack_headers(body: bytes, signing_secret: str)` that generates valid `X-Slack-Signature` and `X-Slack-Request-Timestamp` headers using `slack_sdk.signature.SignatureVerifier.generate_signature()` or manual HMAC computation. This allows sending properly signed requests in tests.

Mock `get_settings()` to return a Settings with known `slack_signing_secret` and `allowed_user_id` for all router tests.

**Endpoint tests (INGEST-01, INGEST-04):**
- `test_url_verification_challenge` -- POST with `type: "url_verification"` and valid signature -> 200 with `{"challenge": "..."}`
- `test_invalid_signature_returns_403` -- POST with wrong/missing signature -> 403
- `test_valid_message_returns_200` -- POST with valid event_callback message -> 200 `{"ok": true}` (INGEST-04: ACK fast)
- `test_retry_header_returns_200_immediately` -- POST with `X-Slack-Retry-Num: 1` header -> 200 without processing
- `test_bot_message_returns_200_no_processing` -- POST with bot message event -> 200 but no background task (INGEST-05)
- `test_message_with_urls_triggers_background` -- POST with valid message containing URLs -> 200, background task dispatched

For signing in tests: use `slack_sdk.signature.SignatureVerifier` to generate valid signatures. Create a test fixture or helper:
```python
import hashlib, hmac, time, json

def sign_request(body: bytes, secret: str) -> tuple[str, str]:
    timestamp = str(int(time.time()))
    sig_basestring = f"v0:{timestamp}:{body.decode()}"
    signature = "v0=" + hmac.new(secret.encode(), sig_basestring.encode(), hashlib.sha256).hexdigest()
    return timestamp, signature
```

Use TestClient from conftest.py fixture (session-scoped). Override `get_settings` dependency in tests to control signing secret and allowed user ID.

3. Update `tests/conftest.py` if needed:
   - Add a fixture for overriding settings in Slack tests, or keep it local to each test file
   - Keep existing session-scoped `client` fixture intact
  </action>
  <verify>
- `uv run pytest tests/test_slack/ -v` -- all tests pass
- `uv run pytest tests/ -v` -- ALL tests pass (existing + new)
- `uv run ruff check tests/` -- linter clean
  </verify>
  <done>Handler filter tests verify all message filtering scenarios (bot, edit, thread, wrong user, no URLs). Router integration tests verify signature checking (403 on invalid), URL verification challenge, retry dedup, and successful message processing. All existing tests still pass.</done>
</task>

</tasks>

<verification>
1. Full test suite: `uv run pytest tests/ -v` -- all tests pass (existing Phase 1 tests + new Phase 2 tests)
2. Test count increased significantly (should have 15+ new tests across 3 files)
3. Linter clean: `uv run ruff check tests/`
4. Each INGEST requirement has at least one test verifying it:
   - INGEST-01: test_url_verification_challenge, test_valid_message_returns_200
   - INGEST-02: test_extract_url_with_label, test_extract_url_without_label, test_extract_multiple_urls
   - INGEST-03: test_user_note_with_text_and_url, test_user_note_url_only
   - INGEST-04: test_valid_message_returns_200 (fast ACK)
   - INGEST-05: test_ignores_subtype_bot_message, test_ignores_bot_id
   - INGEST-06: test_ignores_no_urls
   - INGEST-07: test_multiple_urls_dispatched, test_urls_capped_at_10
   - INGEST-08: (redirect resolution tested via handler integration or separate async test)
</verification>

<success_criteria>
- All new tests pass alongside existing tests
- URL extraction tests cover: with/without label, multiple URLs, no URLs, user mentions excluded, channel refs excluded, query params preserved
- User note tests cover: text with URL, URL only, empty, whitespace
- Handler filter tests cover: non-message type, bot subtype, message_changed subtype, bot_id, wrong user, thread reply, no URLs, valid message
- Router tests cover: URL verification challenge, invalid signature (403), valid message (200), retry header dedup
- Test count: 25+ tests total across all test files
</success_criteria>

<output>
After completion, create `.planning/phases/02-slack-ingress/02-02-SUMMARY.md`
</output>
