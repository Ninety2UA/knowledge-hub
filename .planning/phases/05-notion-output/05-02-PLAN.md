---
phase: 05-notion-output
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/knowledge_hub/notion/service.py
  - src/knowledge_hub/notion/__init__.py
  - tests/test_notion/__init__.py
  - tests/test_notion/test_duplicates.py
  - tests/test_notion/test_tags.py
  - tests/test_notion/test_properties.py
  - tests/test_notion/test_blocks.py
  - tests/test_notion/test_service.py
autonomous: true
requirements: [NOTION-01, NOTION-02, NOTION-03, NOTION-04]

must_haves:
  truths:
    - "Given a NotionPage, the system creates a Notion page with all 10 properties and 4-section body"
    - "Duplicate URLs are detected before page creation and return existing page info"
    - "LLM-suggested tags not in the Notion schema are silently dropped"
    - "Status is always New on every created page"
    - "Long text is split at 2000-char boundaries and blocks are batched at 100"
    - "The normalized URL is stored in the Source property for consistent duplicate matching"
  artifacts:
    - path: "src/knowledge_hub/notion/service.py"
      provides: "create_notion_page orchestrator"
      min_lines: 40
    - path: "tests/test_notion/test_duplicates.py"
      provides: "URL normalization + duplicate check tests"
      min_lines: 40
    - path: "tests/test_notion/test_tags.py"
      provides: "Tag cache + filter tests"
      min_lines: 30
    - path: "tests/test_notion/test_properties.py"
      provides: "Property builder tests"
      min_lines: 40
    - path: "tests/test_notion/test_blocks.py"
      provides: "Block builder tests"
      min_lines: 40
    - path: "tests/test_notion/test_service.py"
      provides: "Page creation service integration tests"
      min_lines: 60
  key_links:
    - from: "src/knowledge_hub/notion/service.py"
      to: "src/knowledge_hub/notion/duplicates.py"
      via: "check_duplicate before page creation"
      pattern: "check_duplicate"
    - from: "src/knowledge_hub/notion/service.py"
      to: "src/knowledge_hub/notion/tags.py"
      via: "get_valid_tags + filter_tags before building properties"
      pattern: "filter_tags"
    - from: "src/knowledge_hub/notion/service.py"
      to: "src/knowledge_hub/notion/properties.py"
      via: "build_properties for API payload"
      pattern: "build_properties"
    - from: "src/knowledge_hub/notion/service.py"
      to: "src/knowledge_hub/notion/blocks.py"
      via: "build_body_blocks for page children"
      pattern: "build_body_blocks"
    - from: "src/knowledge_hub/notion/service.py"
      to: "notion_client AsyncClient"
      via: "pages.create + blocks.children.append"
      pattern: "pages\\.create|blocks\\.children\\.append"
---

<objective>
Wire all Notion building blocks into a page creation service and validate everything with a comprehensive test suite.

Purpose: This plan creates the complete, tested Notion output capability. The service orchestrates duplicate detection, tag filtering, property/block building, and Notion API calls. The test suite validates every module independently plus the full orchestration flow.

Output: service.py orchestrator + 5 test files covering all Notion modules (~170+ lines of tests).
</objective>

<execution_context>
@/Users/dbenger/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dbenger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notion-output/05-RESEARCH.md
@.planning/phases/05-notion-output/05-CONTEXT.md
@.planning/phases/05-notion-output/05-01-SUMMARY.md
@src/knowledge_hub/notion/client.py
@src/knowledge_hub/notion/models.py
@src/knowledge_hub/notion/duplicates.py
@src/knowledge_hub/notion/tags.py
@src/knowledge_hub/notion/properties.py
@src/knowledge_hub/notion/blocks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement page creation service orchestrating all Notion modules</name>
  <files>
    src/knowledge_hub/notion/service.py
    src/knowledge_hub/notion/__init__.py
  </files>
  <action>
**service.py** — The main orchestrator that wires duplicate check, tag filtering, property/block building, and Notion API calls into a single `create_notion_page` function.

- `async def create_notion_page(page: NotionPage) -> PageResult | DuplicateResult`:
  The complete Notion output pipeline:
  1. **Normalize URL**: Call `normalize_url(page.entry.source)` and update `page.entry.source` with the normalized version. This ensures the Source property stores the normalized URL for consistent future duplicate matching (per research open question #3 recommendation).
  2. **Duplicate check** (NOTION-03): Call `check_duplicate(page.entry.source)`. If returns `DuplicateResult`, return it immediately — skip all creation logic. Per user decision: always skip, return existing page info.
  3. **Tag filtering** (NOTION-04): Call `get_valid_tags()` to get cached Notion schema tags. Call `filter_tags(page.entry.tags, valid_tags)` to drop unknown tags. Update `page.entry.tags` with the filtered list.
  4. **Build properties** (NOTION-01, NOTION-02): Call `build_properties(page)` to get the Notion API properties dict. Status is "New" by default from KnowledgeEntry.
  5. **Build blocks**: Call `build_body_blocks(page)` to get the list of Notion block dicts.
  6. **Create page with batch handling**:
     - Get client and data_source_id.
     - First batch: `first_batch = blocks[:100]`, `overflow = blocks[100:]`
     - Call `client.pages.create(parent={"type": "data_source_id", "data_source_id": ds_id}, properties=properties, children=first_batch)`
     - If overflow exists, loop in batches of 100: `client.blocks.children.append(block_id=page_id, children=batch)`
  7. **Return PageResult**: Extract `page["id"]`, `page["url"]`, and the title from the input page.entry.title. Return `PageResult(page_id=..., page_url=..., title=...)`.

- Error handling (Claude's discretion):
  - Let `notion_client.errors.APIResponseError` propagate to caller (Phase 6 orchestrator handles error routing).
  - Log at INFO level on successful creation, WARNING on duplicate skip.
  - If tag filtering during page creation fails with API error mentioning "multi_select" validation (stale cache), catch the error, call `invalidate_tag_cache()`, re-filter tags with fresh cache, and retry the page creation ONCE. This handles the stale cache edge case per user decision (drop silently).

- Import logging at module level: `logger = logging.getLogger(__name__)`

**__init__.py** — Add `create_notion_page` to the public API exports:
```python
from knowledge_hub.notion.service import create_notion_page
```
Add to `__all__` list.
  </action>
  <verify>
    Run `python -c "from knowledge_hub.notion import create_notion_page; print('service imported ok')"` to verify import works. Verify the __init__.py exports are complete: `python -c "import knowledge_hub.notion; print(knowledge_hub.notion.__all__)"`.
  </verify>
  <done>
    create_notion_page() orchestrates the full pipeline: normalize URL -> check duplicate -> filter tags -> build properties -> build blocks -> create page with 100-block batching -> return PageResult or DuplicateResult. Stale tag cache handled with invalidate-and-retry. All public names exported from notion/__init__.py.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive test suite for all Notion modules</name>
  <files>
    tests/test_notion/__init__.py
    tests/test_notion/test_duplicates.py
    tests/test_notion/test_tags.py
    tests/test_notion/test_properties.py
    tests/test_notion/test_blocks.py
    tests/test_notion/test_service.py
  </files>
  <action>
Create `tests/test_notion/__init__.py` (empty file with docstring).

**test_duplicates.py** — Tests for URL normalization and duplicate checking:
- `test_normalize_strips_utm_params`: Input `https://example.com/post?utm_source=twitter&utm_medium=social&id=5` -> output should have `id=5` but no utm_* params.
- `test_normalize_protocol_to_https`: Input `http://example.com/page` -> output starts with `https://`.
- `test_normalize_strips_trailing_slash`: Input `https://example.com/page/` -> no trailing slash.
- `test_normalize_combined`: Tests all three normalizations together.
- `test_normalize_preserves_non_utm_params`: Input with `ref=abc&utm_campaign=x` -> `ref=abc` preserved, `utm_campaign` removed.
- `test_check_duplicate_found`: Mock `client.data_sources.query` to return a result. Assert returns `DuplicateResult` with correct page_id, page_url, title.
- `test_check_duplicate_not_found`: Mock query returning empty results. Assert returns None.
- `test_check_duplicate_no_title_fallback`: Mock query result with empty title array. Assert title is "Untitled".

Use `unittest.mock.patch` on `knowledge_hub.notion.duplicates` module attributes (matching project's test pattern). For async mocks, use `unittest.mock.AsyncMock`.

**test_tags.py** — Tests for tag caching and filtering:
- `test_filter_tags_keeps_valid`: `filter_tags(["AI", "Unknown", "Python"], {"AI", "Python", "Data"})` -> `["AI", "Python"]`.
- `test_filter_tags_preserves_order`: Verify output order matches input order.
- `test_filter_tags_all_invalid`: All suggestions invalid -> returns empty list.
- `test_filter_tags_all_valid`: All suggestions valid -> returns all.
- `test_get_valid_tags_caches`: Mock `data_sources.retrieve` to return options. Call twice, assert retrieve called only once.
- `test_get_valid_tags_after_invalidate`: Call get_valid_tags, invalidate, call again. Assert retrieve called twice.

**test_properties.py** — Tests for the property builder:
- `test_build_properties_all_10_keys`: Build from a valid NotionPage, assert all 10 property keys present.
- `test_build_properties_title_format`: Assert title is `{"title": [{"text": {"content": "..."}}]}`.
- `test_build_properties_select_fields`: Assert Category, Content Type, Status, Priority all use `{"select": {"name": "..."}}`.
- `test_build_properties_status_always_new`: Assert Status.select.name == "New" regardless of input.
- `test_build_properties_url_field`: Assert Source is `{"url": "..."}`.
- `test_build_properties_date_field`: Assert Date Added has `{"date": {"start": "..."}}` with ISO format.
- `test_build_properties_tags_multi_select`: Assert Tags is `{"multi_select": [{"name": "..."}]}`.
- `test_build_properties_long_summary_split`: Create entry with summary > 2000 chars. Assert Summary rich_text has multiple chunks, each <= 2000 chars.
- `test_build_properties_author_none`: Assert author=None produces empty string in rich_text.

Use helper factory `_make_page(**overrides)` returning a valid NotionPage instance (following project pattern of `_make_entry()` from test_models).

**test_blocks.py** — Tests for the block builder:
- `test_build_body_blocks_has_4_sections`: Assert 4 heading_2 blocks exist with correct text ("Summary", "Key Points", "Key Learnings & Actionable Steps", "Detailed Notes").
- `test_build_body_blocks_summary_section`: Assert paragraph block follows Summary heading.
- `test_build_body_blocks_key_points_numbered`: Assert numbered_list_item blocks for each key point.
- `test_build_body_blocks_key_learnings_structure`: Assert bold paragraph for "what", paragraph for "why it matters", numbered items for "how to apply" steps.
- `test_build_body_blocks_detailed_notes_paragraphs`: Assert detailed_notes text renders as paragraph blocks.
- `test_build_body_blocks_detailed_notes_subheadings`: Assert "## Sub" in detailed_notes renders as heading_3.
- `test_build_body_blocks_detailed_notes_bullet_lists`: Assert "- item" in detailed_notes renders as bulleted_list_item.
- `test_build_body_blocks_has_dividers`: Assert divider blocks between sections.
- `test_build_body_blocks_long_text_split`: Assert paragraph with > 2000 chars has multiple rich_text chunks.

**test_service.py** — Tests for the page creation orchestrator:
- Helper: `_make_page(**overrides)` factory for creating valid NotionPage instances.
- `test_create_page_success`: Mock all dependencies (check_duplicate returns None, get_valid_tags returns set matching page tags, pages.create returns success). Assert returns PageResult with correct fields.
- `test_create_page_duplicate_skipped`: Mock check_duplicate to return DuplicateResult. Assert create_notion_page returns DuplicateResult WITHOUT calling pages.create.
- `test_create_page_tags_filtered`: Mock get_valid_tags returning {"AI", "Python"}. Page has tags ["AI", "Unknown", "Python"]. Assert pages.create called with tags ["AI", "Python"] only.
- `test_create_page_url_normalized`: Page with source "http://example.com/post?utm_source=x". Assert pages.create called with normalized URL in Source property.
- `test_create_page_overflow_blocks`: Mock build_body_blocks to return 150 blocks. Assert pages.create called with first 100 children AND blocks.children.append called with remaining 50.
- `test_create_page_status_new`: Assert the properties dict passed to pages.create has Status.select.name == "New".

All async tests use `pytest.mark.asyncio` (or use `pytest-asyncio` auto mode if configured). Mock Notion API calls with `AsyncMock` — NEVER make real API calls. Patch at the module level where the name is used (e.g., `patch("knowledge_hub.notion.service.check_duplicate")`).

Run full suite: `uv run pytest` and verify all new tests pass plus 0 regressions on existing 145+ tests.
  </action>
  <verify>
    `uv run pytest tests/test_notion/ -v` to see all new tests pass. `uv run pytest` to verify full suite (should be 145+ existing + new notion tests) with 0 failures.
  </verify>
  <done>
    5 test files covering: URL normalization (5+ tests), tag filtering/caching (6+ tests), property building (9+ tests), block building (9+ tests), page creation service (6+ tests). All tests pass. Full suite runs with 0 regressions. Phase 5 Notion output is complete and tested.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_notion/ -v` — all new tests pass
2. `uv run pytest` — full suite passes with 0 regressions (145+ existing + ~35 new)
3. create_notion_page() handles: duplicate skip, tag filtering, URL normalization, property building, block building, 100-block batching
4. No real Notion API calls in tests — all mocked
5. Status is "New" on every created page (NOTION-02)
6. Duplicate check returns existing page info for Phase 6 notifications (NOTION-03)
7. Unknown tags dropped silently (NOTION-04)
</verification>

<success_criteria>
- service.py orchestrates the complete Notion output pipeline
- ~35+ new tests across 5 test files, all passing
- Full test suite (180+ tests) passes with 0 regressions
- All 4 NOTION requirements (01-04) are covered
- Ready for Phase 6 to call create_notion_page() in the pipeline orchestrator
</success_criteria>

<output>
After completion, create `.planning/phases/05-notion-output/05-02-SUMMARY.md`
</output>
