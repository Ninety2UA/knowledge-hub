---
phase: 05-notion-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/knowledge_hub/notion/__init__.py
  - src/knowledge_hub/notion/client.py
  - src/knowledge_hub/notion/models.py
  - src/knowledge_hub/notion/duplicates.py
  - src/knowledge_hub/notion/tags.py
  - src/knowledge_hub/notion/properties.py
  - src/knowledge_hub/notion/blocks.py
autonomous: true
requirements: [NOTION-01, NOTION-02, NOTION-03, NOTION-04]

must_haves:
  truths:
    - "NotionPage model can be mapped to a complete Notion API property dict with all 10 properties"
    - "Page body sections render as properly formatted Notion blocks (headings, paragraphs, numbered lists, dividers)"
    - "A URL can be normalized and checked for duplicates in the Notion database"
    - "Tags from the LLM are filtered against the Notion schema before use"
    - "Status is always set to New on page creation properties"
  artifacts:
    - path: "src/knowledge_hub/notion/client.py"
      provides: "AsyncClient singleton + data_source_id discovery"
      min_lines: 30
    - path: "src/knowledge_hub/notion/models.py"
      provides: "PageResult and DuplicateResult types"
      min_lines: 15
    - path: "src/knowledge_hub/notion/duplicates.py"
      provides: "URL normalization + duplicate query"
      min_lines: 25
    - path: "src/knowledge_hub/notion/tags.py"
      provides: "Tag cache with TTL + filter function"
      min_lines: 30
    - path: "src/knowledge_hub/notion/properties.py"
      provides: "NotionPage -> Notion API property dict builder"
      min_lines: 30
    - path: "src/knowledge_hub/notion/blocks.py"
      provides: "NotionPage body -> Notion block list builder"
      min_lines: 60
  key_links:
    - from: "src/knowledge_hub/notion/properties.py"
      to: "knowledge_hub.models.knowledge.KnowledgeEntry"
      via: "reads entry fields to build property dict"
      pattern: "entry\\.title|entry\\.category|entry\\.source"
    - from: "src/knowledge_hub/notion/blocks.py"
      to: "knowledge_hub.models.notion.NotionPage"
      via: "reads body sections to build block list"
      pattern: "page\\.summary_section|page\\.key_points|page\\.key_learnings|page\\.detailed_notes"
    - from: "src/knowledge_hub/notion/duplicates.py"
      to: "notion_client AsyncClient"
      via: "data_sources.query with URL filter"
      pattern: "data_sources\\.query"
    - from: "src/knowledge_hub/notion/tags.py"
      to: "notion_client AsyncClient"
      via: "data_sources.retrieve for schema options"
      pattern: "data_sources\\.retrieve"
---

<objective>
Build all Notion output building blocks: client singleton, result models, URL normalization + duplicate detection, tag validation cache, property builder, and block builder.

Purpose: These pure-function builders and thin API wrappers are the foundation that Plan 02 wires into a complete page creation service. Separating them keeps each module testable and focused.

Output: 7 modules in src/knowledge_hub/notion/ covering client management, data mapping, duplicate detection, and tag filtering.
</objective>

<execution_context>
@/Users/dbenger/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dbenger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notion-output/05-RESEARCH.md
@.planning/phases/05-notion-output/05-CONTEXT.md
@.planning/phases/04-llm-processing/04-02-SUMMARY.md
@src/knowledge_hub/models/notion.py
@src/knowledge_hub/models/knowledge.py
@src/knowledge_hub/config.py
@src/knowledge_hub/llm/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create client singleton, result models, duplicate detection, and tag cache</name>
  <files>
    pyproject.toml
    src/knowledge_hub/notion/client.py
    src/knowledge_hub/notion/models.py
    src/knowledge_hub/notion/duplicates.py
    src/knowledge_hub/notion/tags.py
  </files>
  <action>
**Dependencies:** Run `uv add notion-client url-normalize cachetools` to add all three packages.

**client.py** — Async Notion client singleton following the same pattern as `llm/client.py`:
- Module-level `_client: AsyncClient | None = None` and `_data_source_id: str | None = None`
- `async def get_notion_client() -> AsyncClient`: Creates `AsyncClient(auth=settings.notion_api_key)` on first call using `get_settings()`, caches in global. Returns cached instance.
- `async def get_data_source_id() -> str`: On first call, uses `get_notion_client()` to call `client.databases.retrieve(database_id=settings.notion_database_id)`, extracts `db["data_sources"][0]["id"]`, caches in `_data_source_id`. If `data_sources` is empty or missing, raise `RuntimeError` with clear message including the database_id.
- `def reset_client() -> None`: Resets both `_client` and `_data_source_id` to None (for testing).
- Import from `notion_client` (note underscore — the package installs as `notion-client` but imports as `notion_client`).

**models.py** — Result types for downstream consumers:
- `class PageResult(BaseModel)`: `page_id: str`, `page_url: str`, `title: str` — returned after successful page creation.
- `class DuplicateResult(BaseModel)`: `page_id: str`, `page_url: str`, `title: str` — returned when a duplicate is found.
- Both are simple Pydantic models. Keep in separate file from domain models since these are Notion-service-specific.

**duplicates.py** — URL normalization + duplicate query (NOTION-03):
- `def normalize_url(raw_url: str) -> str`: Uses `url_normalize(raw_url)` from `url_normalize` package. ALSO manually strip `utm_*` query params by parsing with `urllib.parse.urlparse`/`parse_qs`/`urlencode` and removing keys starting with `utm_`. The `url-normalize` library with `filter_params=True` removes ALL params — we only want to remove tracking params. After stripping utm_*, pass through `url_normalize()` for protocol/trailing-slash normalization.
- `async def check_duplicate(raw_url: str) -> DuplicateResult | None`: Gets client and data_source_id. Calls `client.data_sources.query(data_source_id=ds_id, filter={"property": "Source", "url": {"equals": normalized}}, page_size=1)`. If results non-empty, extract page id, url, and title (from `properties["Title"]["title"][0]["plain_text"]` with fallback to "Untitled"). Return `DuplicateResult` or None.

**tags.py** — Tag validation with TTL cache (NOTION-04):
- Use `cachetools.TTLCache(maxsize=1, ttl=300)` (5-minute TTL — Claude's discretion).
- `async def get_valid_tags() -> set[str]`: Check cache first. On miss, call `client.data_sources.retrieve(data_source_id=ds_id)`, extract `ds["properties"]["Tags"]["multi_select"]["options"]`, build `set[str]` of option names, store in cache, return.
- `def filter_tags(suggested: list[str], valid: set[str]) -> list[str]`: Pure function. Returns `[t for t in suggested if t in valid]`. Preserves order.
- `def invalidate_tag_cache() -> None`: Clears the TTL cache (for testing).

Per user decision: Notion is source of truth for tags. LLM-suggested tags not in Notion schema are DROPPED silently. No auto-adding.
  </action>
  <verify>
    Run `uv sync` to verify lockfile resolves. Run `python -c "from knowledge_hub.notion.client import get_notion_client, get_data_source_id, reset_client; from knowledge_hub.notion.models import PageResult, DuplicateResult; from knowledge_hub.notion.duplicates import normalize_url, check_duplicate; from knowledge_hub.notion.tags import get_valid_tags, filter_tags, invalidate_tag_cache; print('all imports ok')"` to verify all modules importable. Run `python -c "from knowledge_hub.notion.duplicates import normalize_url; assert normalize_url('http://example.com/page?utm_source=twitter&id=5') == 'https://example.com/page?id=5' or 'normalized'; print(normalize_url('http://example.com/page?utm_source=twitter&id=5'))"` to verify URL normalization works.
  </verify>
  <done>
    Three packages installed (notion-client, url-normalize, cachetools). Client singleton creates AsyncClient from config and discovers data_source_id. normalize_url strips utm_* params and normalizes protocol/slashes. check_duplicate queries Notion via data_sources.query with URL filter. get_valid_tags fetches and caches tag options with 5-minute TTL. filter_tags drops unknown tags. All modules importable with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build property mapper and block builder for Notion page creation</name>
  <files>
    src/knowledge_hub/notion/properties.py
    src/knowledge_hub/notion/blocks.py
    src/knowledge_hub/notion/__init__.py
  </files>
  <action>
**properties.py** — Pure function mapping NotionPage to Notion API properties dict (NOTION-01, NOTION-02):
- `def _split_rich_text(text: str, limit: int = 2000) -> list[dict]`: Splits text into chunks of `limit` chars, returns list of `{"type": "text", "text": {"content": chunk}}` dicts. Every text field MUST go through this to respect Notion's 2000-char limit.
- `def build_properties(page: NotionPage) -> dict`: Maps all 10 KnowledgeEntry fields:
  - `"Title"`: `{"title": [{"text": {"content": entry.title}}]}` (title is short, unlikely to exceed limit but wrap anyway)
  - `"Category"`: `{"select": {"name": entry.category.value}}`
  - `"Content Type"`: `{"select": {"name": entry.content_type.value}}`
  - `"Source"`: `{"url": entry.source}` — NOTE: source URL must be the NORMALIZED URL (caller is responsible for setting this before calling build_properties)
  - `"Author/Creator"`: `{"rich_text": _split_rich_text(entry.author or "")}`
  - `"Date Added"`: `{"date": {"start": entry.date_added.isoformat()}}`
  - `"Status"`: `{"select": {"name": entry.status.value}}` — Always "New" per NOTION-02 (enforced by KnowledgeEntry default)
  - `"Priority"`: `{"select": {"name": entry.priority.value}}`
  - `"Tags"`: `{"multi_select": [{"name": t} for t in entry.tags]}`
  - `"Summary"`: `{"rich_text": _split_rich_text(entry.summary)}`
- This is a PURE function. No API calls, no async. Takes a NotionPage, returns a dict.

**blocks.py** — Pure function converting NotionPage body into Notion block objects (NOTION-01):
- `def _split_rich_text(text: str, limit: int = 2000) -> list[dict]`: Same helper as in properties.py — duplicate it here rather than creating a shared utils file (both files need it independently, keeps modules self-contained). OR extract to a small `_text.py` helper if preferred.
- `def _heading_block(text: str, level: int = 2) -> dict`: Creates `heading_2` or `heading_3` block with rich_text.
- `def _paragraph_block(text: str) -> dict`: Creates paragraph block with `_split_rich_text`.
- `def _numbered_item_block(text: str) -> dict`: Creates `numbered_list_item` block.
- `def _bulleted_item_block(text: str) -> dict`: Creates `bulleted_list_item` block.
- `def _divider_block() -> dict`: Returns `{"object": "block", "type": "divider", "divider": {}}`.
- `def _bold_paragraph_block(text: str) -> dict`: Creates a paragraph with annotations `{"bold": true}` on the rich_text (NOT markdown `**text**` which renders as literal asterisks in Notion).
- `def build_body_blocks(page: NotionPage) -> list[dict]`: Builds the 4 sections:
  1. **Summary**: heading_2("Summary") + paragraph(page.summary_section) + divider
  2. **Key Points**: heading_2("Key Points") + numbered_item for each point + divider
  3. **Key Learnings & Actionable Steps**: heading_2("Key Learnings & Actionable Steps") + for each KeyLearning: bold_paragraph(kl.what) + paragraph("Why it matters: " + kl.why_it_matters) + numbered_item for each how_to_apply step + divider (between learnings, or just after the section)
  4. **Detailed Notes**: heading_2("Detailed Notes") + parse paragraphs from detailed_notes text: split on "\n\n", render subheadings (## -> heading_3), bullet lists (- -> bulleted_list_item), otherwise paragraph
- Returns list[dict]. Caller handles the 100-block batch limit.

**__init__.py** — Update to export public API. For now, export the building blocks that Plan 02 will wire together:
```python
from knowledge_hub.notion.client import get_notion_client, get_data_source_id, reset_client
from knowledge_hub.notion.models import PageResult, DuplicateResult
from knowledge_hub.notion.duplicates import normalize_url, check_duplicate
from knowledge_hub.notion.tags import get_valid_tags, filter_tags, invalidate_tag_cache
from knowledge_hub.notion.properties import build_properties
from knowledge_hub.notion.blocks import build_body_blocks
```
  </action>
  <verify>
    Run `python -c "from knowledge_hub.notion.properties import build_properties; from knowledge_hub.notion.blocks import build_body_blocks; print('builders imported ok')"`. Create a quick inline test: `python -c "
from knowledge_hub.notion.properties import build_properties
from knowledge_hub.models import NotionPage, KnowledgeEntry, KeyLearning, Category, ContentType, Priority, Status
from datetime import datetime, timezone
entry = KnowledgeEntry(title='Test', category=Category.AI_ML, content_type=ContentType.ARTICLE, source='https://example.com', date_added=datetime.now(timezone.utc), priority=Priority.HIGH, tags=['AI'], summary='A test summary')
page = NotionPage(entry=entry, summary_section='Summary text', key_points=['Point 1'], key_learnings=[KeyLearning(what='Learn', why_it_matters='Matters', how_to_apply=['Step 1'])], detailed_notes='Some notes')
props = build_properties(page)
assert 'Title' in props and 'Status' in props and props['Status']['select']['name'] == 'New'
print('property builder OK, 10 properties:', len(props))
"`. Run existing test suite: `uv run pytest` to verify no regressions.
  </verify>
  <done>
    build_properties() maps all 10 KnowledgeEntry fields to Notion API property format with 2000-char text splitting. build_body_blocks() renders 4 sections as Notion blocks with headings, paragraphs, numbered lists, bold annotations, and dividers. notion/__init__.py re-exports all public names. All 145+ existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `uv sync` succeeds with notion-client, url-normalize, cachetools resolved
2. All notion/ modules importable: client, models, duplicates, tags, properties, blocks
3. normalize_url strips utm_* params and normalizes protocol + trailing slashes
4. filter_tags drops tags not in the valid set
5. build_properties produces dict with all 10 Notion property keys
6. build_body_blocks produces a list of block dicts with 4 sections
7. `uv run pytest` passes with 0 regressions
</verification>

<success_criteria>
- 7 new modules in src/knowledge_hub/notion/ (client.py, models.py, duplicates.py, tags.py, properties.py, blocks.py, __init__.py updated)
- All building blocks are importable and functional
- No existing tests broken
- Ready for Plan 02 to wire into page creation service with tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-notion-output/05-01-SUMMARY.md`
</output>
