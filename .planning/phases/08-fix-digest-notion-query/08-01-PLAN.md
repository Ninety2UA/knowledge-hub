---
phase: 08-fix-digest-notion-query
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/knowledge_hub/digest.py
  - tests/test_digest.py
autonomous: true
gap_closure: true
requirements:
  - DEPLOY-06

must_haves:
  truths:
    - "query_recent_entries() uses client.data_sources.query (not client.databases.query)"
    - "kwargs uses data_source_id key (not database_id key)"
    - "Tests mock client.data_sources.query (not client.databases.query)"
    - "Test assertions verify data_source_id parameter name (not database_id)"
    - "All existing digest tests still pass"
    - "No occurrences of databases.query remain in digest.py or test_digest.py"
  artifacts:
    - path: "src/knowledge_hub/digest.py"
      provides: "Fixed Notion query using data_sources.query endpoint"
      contains: "client.data_sources.query"
    - path: "tests/test_digest.py"
      provides: "Tests validating correct API endpoint and parameter names"
      contains: "data_sources.query"
  key_links:
    - from: "src/knowledge_hub/digest.py"
      to: "notion.client.get_data_source_id"
      via: "data_source_id passed as data_source_id kwarg to data_sources.query"
      pattern: "data_sources\\.query\\(.*data_source_id"
    - from: "src/knowledge_hub/digest.py"
      to: "src/knowledge_hub/notion/duplicates.py"
      via: "Same API pattern: get_data_source_id() -> data_sources.query(data_source_id=ds_id)"
      pattern: "client\\.data_sources\\.query"
---

<objective>
Fix the data_source_id/database_id mismatch in digest.py that will cause the weekly digest to fail at runtime with a Notion API error.

Purpose: The audit found that digest.py passes the value from get_data_source_id() as `database_id` to `client.databases.query()`, but the correct pattern (used by duplicates.py) is `client.data_sources.query(data_source_id=ds_id)`. Tests mask the bug because both sides use the same mock string. This fix ensures POST /digest works in production.

Output: Fixed digest.py and test_digest.py with correct Notion API endpoint and parameter names.
</objective>

<execution_context>
@/Users/dbenger/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dbenger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-fix-digest-notion-query/08-RESEARCH.md
@src/knowledge_hub/notion/duplicates.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix digest.py Notion API endpoint and parameter name</name>
  <files>src/knowledge_hub/digest.py</files>
  <action>
In `query_recent_entries()`, make exactly two changes to match the pattern in duplicates.py:

1. **Line 39** — Change the kwarg key from `"database_id"` to `"data_source_id"`:
   - Before: `"database_id": data_source_id,`
   - After: `"data_source_id": data_source_id,`

2. **Line 48** — Change the API method from `databases.query` to `data_sources.query`:
   - Before: `result = await client.databases.query(**kwargs)`
   - After: `result = await client.data_sources.query(**kwargs)`

No other changes needed. The filter format, pagination logic, and entry extraction are all correct.
  </action>
  <verify>
Run: `grep -n "databases.query\|database_id" src/knowledge_hub/digest.py`
Expected: Zero matches. All references should now be `data_sources.query` and `data_source_id`.

Run: `grep -n "data_sources.query\|data_source_id" src/knowledge_hub/digest.py`
Expected: Two matches — the kwarg key and the API call.
  </verify>
  <done>digest.py uses client.data_sources.query(data_source_id=...) matching the duplicates.py pattern exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Update test_digest.py to mock correct API endpoint and assert correct parameter name</name>
  <files>tests/test_digest.py</files>
  <action>
Update ALL occurrences of `databases.query` in test_digest.py. There are two test functions to fix:

**1. `test_query_recent_entries` (lines 103-121):**
- Line 106: Change `mock_client.databases.query.return_value` to `mock_client.data_sources.query.return_value`
- Line 118: Change `mock_client.databases.query.assert_called_once()` to `mock_client.data_sources.query.assert_called_once()`
- Line 119: Change `mock_client.databases.query.call_args[1]` to `mock_client.data_sources.query.call_args[1]`
- Line 120: Change `call_kwargs["database_id"]` to `call_kwargs["data_source_id"]`
- Add new assertion after line 120: `assert "database_id" not in call_kwargs` to prevent regression

**2. `test_query_recent_entries_pagination` (lines 124-150):**
- Line 128: Change `mock_client.databases.query.side_effect` to `mock_client.data_sources.query.side_effect`
- Line 147: Change `mock_client.databases.query.call_count` to `mock_client.data_sources.query.call_count`
- Line 149: Change `mock_client.databases.query.call_args_list[1][1]` to `mock_client.data_sources.query.call_args_list[1][1]`

After changes, verify no occurrences of `databases.query` remain anywhere in the test file.
  </action>
  <verify>
Run: `grep -n "databases.query\|database_id" tests/test_digest.py`
Expected: Zero matches. All references should now be `data_sources.query` and `data_source_id`.

Run: `cd /Users/dbenger/projects/knowledge-hub && python -m pytest tests/test_digest.py -v`
Expected: All 10 tests pass.

Run: `cd /Users/dbenger/projects/knowledge-hub && python -m pytest tests/ -x --timeout=30`
Expected: Full test suite passes with no regressions.
  </verify>
  <done>All test mocks target data_sources.query, assertions check data_source_id parameter name, negative assertion prevents database_id regression, all tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -rn "databases.query\|database_id" src/knowledge_hub/digest.py tests/test_digest.py` — Zero hits
2. `grep -rn "data_sources.query" src/knowledge_hub/digest.py tests/test_digest.py` — Hits in both files
3. `python -m pytest tests/test_digest.py -v` — All 10 tests pass
4. `python -m pytest tests/ -x` — Full suite passes, no regressions
5. Pattern match: digest.py query pattern matches duplicates.py pattern exactly
</verification>

<success_criteria>
- digest.py uses `client.data_sources.query(data_source_id=...)` (not `client.databases.query(database_id=...)`)
- Tests mock and assert against `data_sources.query` with `data_source_id` parameter name
- Negative assertion `"database_id" not in call_kwargs` prevents future regression
- All 10 digest tests pass, full test suite has no regressions
- Zero occurrences of `databases.query` or `database_id` in either file
</success_criteria>

<output>
After completion, create `.planning/phases/08-fix-digest-notion-query/08-01-SUMMARY.md`
</output>
